---
title: "NeuriViz (Part 2) - EEG Topoplots"
image:
  path: /assets/brain_tiles.png
comments: true
share: true
tags:
    - julia
    - neuroscience
    - visualization
---

In [Part 1 of NeuriViz](/neuriviz-1/) project updates, I laid out the purpose and general approach I am taking to creating neuroscientific visualizations.
The first visualization I had the goal of creating was an EEG topoplot inspired by such projects like [EEGLAB](https://sccn.ucsd.edu/eeglab/index.php) and [MNE](https://mne.tools/stable/index.html).
I am happy to say that, after writing this in pure Julia, that this goal has now been achieved!

![](/assets/topoplot_v1_proto.png)
{: style="text-align: center;"}

The following sections takes you through how I accomplished this!

# Preparing BIDS EEG Data from OpenNEURO

As I talked about in [my previous post](http://jacobzelko.com/neuriviz-1/#neuriviz-data-to-visualization-pipelines), I am using data from [OpenNEURO](https://openneuro.org/) which is a "A free and open platform for sharing MRI, MEG, EEG, iEEG, and ECoG data". [1]
The data follows the [Brain Imaging Data Structure (BIDS)](https://bids.neuroimaging.io/) so the first order of business was parsing this data. [2] 
Furthermore, I am using the [_Go-nogo categorization and detection task_](https://openneuro.org/datasets/ds002680/versions/1.0.0) dataset by Delorme et. al. [3] which was made in conjunction with the tool, [EEGLAB](https://sccn.ucsd.edu/eeglab/index.php). [4]
As a result, the data is not readily accessible to Julia.

Sadness abounds! :sob:

However, thankfully, we can convert the data into formats that Julia can easily read and work with!
From the dataset, there were only three files for each subjects' session that I used to create the topoplot; here they are ranked in order of importance:

1. `.fdt` files which stores the raw EEG recordings' "float data" in a binary format. [1]
2. `.set` files, which are actually MATLAB `mat` files, go alongside `.fdt` files to store Metadata related to that session (e.g. channels being used, sampling frequency, etc.). [2]
3. `.tsv` files which show how many electrodes were used and where they were attached on the skull.

For my use case, I decided to convert these files to the [Apache Arrow](https://arrow.apache.org/) file format as specified by [`feather`](https://ursalabs.org/blog/2020-feather-v2/).
The rationale is that Julia has strong support for Arrow thanks to the [JuliaData organization](https://github.com/JuliaData) and [`Arrow.jl`](https://github.com/JuliaData/Arrow.jl) which is supported by Julia Developer, [Jacob Quinn](https://quinnj.home.blog/), strong interoperability with [`DataFrames.jl`](https://github.com/JuliaData/DataFrames.jl) thanks to [Bogumił Kamiński](http://bogumilkaminski.pl/about/) so we can work easily with dataframe structures, and [is incredibly fast](http://jacobzelko.com/neuriviz-1/#neuriviz-data-to-visualization-pipelines) to work with. 
I will spare most of the details on how this was done, but if you are curious, NeuriViz provides a script called `load_dataset.jl` which handles this conversion for you.
Feel free to check that out in `neuriviz/scripts/load_dataset.jl`.

Once the data has been processed, we are good to go on with creating the topoplot!

> **NOTE: How is NeuriViz structured?**
>
> You may notice if you visit the [NeuriViz Repo](https://github.com/TheCedarPrince/NeuriViz), it seems to follow a specific structure.
> This structure is provided by the great project, [`DrWatson.jl`](https://github.com/JuliaDynamics/DrWatson.jl) created by theoretical physicist [George Datseris](https://datseris.github.io/).
It's goal is to create easily reproducible Julia code bases around scientific exploration.
> The `DrWatson.jl` directory structure is as follows, and is what NeuriViz uses:
``````
│projectdir          <- Project's main folder. It is initialized as a Git
│                       repository with a reasonable .gitignore file.
│
├── _research        <- WIP scripts, code, notes, comments,
│   |                   to-dos and anything in an alpha state.
│   └── tmp          <- Temporary data folder.
│
├── data             <- **Immutable and add-only!**
│   ├── sims         <- Data resulting directly from simulations.
│   ├── exp_pro      <- Data from processing experiments.
│   └── exp_raw      <- Raw experimental data.
│
├── plots            <- Self-explanatory.
├── notebooks        <- Jupyter, Weave or any other mixed media notebooks.
│
├── papers           <- Scientific papers resulting from the project.
│
├── scripts          <- Various scripts, e.g. simulations, plotting, analysis,
│   │                   The scripts use the `src` folder for their base code.
│   └── intro.jl     <- Simple file that uses DrWatson and uses its greeting.
│
├── src              <- Source code for use in this project. Contains functions,
│                       structures and modules that are used throughout
│                       the project and in multiple scripts.
│
├── README.md        <- Optional top-level README for anyone using this project.
├── .gitignore       <- by default ignores _research, data, plots, videos,
│                       notebooks and latex-compilation related files.
│
├── Manifest.toml    <- Contains full list of exact package versions used currently.
└── Project.toml     <- Main project file, allows activation and installation.
                        Includes DrWatson by default.
``````

# Mapping EEG Electrode Locations

_Delorme et. al._ reports in their paper on the _Go-nogo_ dataset that after processing, their topoplot, with the associated EEG electrode array, looks like this:

![](/assets/delorme_topoplot.png)
{: style="text-align: center;"}

To reproduce the EEG channel array, NeuriViz provides a function called `load_eeg_data` which takes as input three paths: 

- EEG data that you want to load
- Electrode information associated with that EEG data
- Event data from that recording session

This returns an array of `Electrode` object which define its `label`, `position` on the head, and `data` recorded from that channel for that session.


![](/assets/prototype_javis_render.jpg)
{: style="text-align: center;"}

> **NOTE: Why are channel locations not the same on a NeuriViz topoplot?**
>
> As an aside, if you notice, the electrodes in the Delorme topoplot are actually set inside the head of their topoplot more than mine.
I investigated why this is and while exploring EEGLAB (version 9.4.0.813654 (R2018a)), I found [`topoplot.m`](https://github.com/sccn/eeglab/blob/develop/functions/sigprocfunc/topoplot.m).
It is quite possible the kwarg of that function, `headrad`, was used to pretty the plot as it can mess with the anatomical proportions.
Furthermore, the paper does state that "arbitrary units were used in the construction of that graphic. 
Since they did not provide their code, I think it reasonable that this accounts for differences.

# Constructing a Channel Grid


![](/assets/heatmap_prototype_2.png)
{: style="text-align: center;"}

# Creating an EEG Heatmap

# Combining Everything to a Topoplot

![](/assets/topoplot_v1_proto.png)
{: style="text-align: center;"}

